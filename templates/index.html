<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu VMS - Gerenciador de Câmeras</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
        .container { display: flex; flex-wrap: wrap; padding: 20px; }
        
        /* NOVO: Coluna de Câmeras (conteúdo principal) */
        .camera-column {
            flex: 3; /* Ocupa 3/4 */
            display: flex;
            flex-wrap: wrap; /* Câmeras quebram a linha */
            justify-content: center;
            align-content: flex-start;
        }
        
        /* NOVO: Barra Lateral (player) */
        .sidebar {
            flex: 1; /* Ocupa 1/4 */
            min-width: 300px;
            margin: 10px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* Faz a sidebar ter a altura da tela */
            height: 90vh; 
            position: sticky; /* Fica "presa" no lugar */
            top: 20px;
        }

        h1 { width: 100%; text-align: center; color: #0056b3; }
        h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        /* NOVO: Estilo do "Bloco" de cada câmera */
        .camera-pod {
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 10px;
            padding: 15px;
            text-align: center;
        }
        .camera-pod h3 {
            margin-top: 0;
            color: #0056b3;
            text-transform: capitalize; /* Deixa "webcam" como "Webcam" */
        }
        .camera-pod img {
            width: 640px;
            height: 480px;
            background-color: #000;
            display: block;
        }
        .camera-pod .status-message {
            margin-top: 10px;
            font-size: 16px;
            color: #555;
            font-weight: bold;
        }
        .camera-pod .controls { margin-top: 10px; }

        /* Estilos dos Botões (iguais) */
        .btn { padding: 8px 15px; font-size: 14px; cursor: pointer; border: none; border-radius: 5px; color: white; margin: 5px; }
        .btn-start { background-color: #28a745; }
        .btn-stop { background-color: #dc3545; }
        .btn-motion { background-color: #17a2b8; }
        .btn-motion.active { background-color: #ffc107; color: #333; }
        .btn-refresh { background-color: #007bff; }
        
        /* Player (igual) */
        #video-player-container { margin-top: 20px; background-color: #000; }
        #video-player { width: 100%; border: 1px solid #ddd; }
        #video-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #video-list li { padding: 10px; border-bottom: 1px solid #eee; }
        #video-list a { text-decoration: none; color: #0056b3; cursor: pointer; font-weight: bold; }
        #video-list a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gerenciador de Múltiplas Câmeras (VMS)</h1>

        <div class="camera-column" id="camera-column">
            </div>

        <div class="sidebar">
            <h2>Gravações Salvas</h2>
            <button id="btn-refresh" class="btn btn-refresh">Atualizar Lista</button>
            <div id="video-player-container">
                <video id="video-player" controls>
                    <source src="" type="video/webm">
                </video>
            </div>
            <ul id="video-list">
                </ul>
        </div>
    </div>

    <template id="camera-pod-template">
        <div class="camera-pod">
            <h3 class="cam-title"></h3>
            <img class="video-stream" src="" alt="Stream de Vídeo" width="640" height="480">
            <div class="status-message">Status: Carregando...</div>
            <div class="controls">
                <button class="btn btn-start">Gravar Manual</button>
                <button class="btn btn-stop">Parar Manual</button>
                <button class="btn btn-motion">Ligar Detecção</button>
            </div>
        </div>
    </template>

    <script>
        // --- Ponto de Entrada: Carregar tudo ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCameras(); // NOVO: Carrega as câmeras primeiro
            loadVideoList(); // Carrega a lista de gravações (igual)
            
            // NOVO: Adiciona 'escutadores' de eventos em um nível superior
            // (Event Delegation)
            document.getElementById('camera-column').addEventListener('click', handleCameraControls);
            
            // Botão de refresh da lista de playback (igual)
            document.getElementById('btn-refresh').addEventListener('click', loadVideoList);
        });

        /**
         * NOVO: Carrega a lista de câmeras do servidor e constrói a UI
         */
        async function loadCameras() {
            try {
                const response = await fetch('/get_cameras');
                const data = await response.json();
                const cameraColumn = document.getElementById('camera-column');
                const template = document.getElementById('camera-pod-template');
                
                for (const camId of data.cameras) {
                    // Clona o molde (template)
                    const podClone = template.content.cloneNode(true);
                    const podElement = podClone.querySelector('.camera-pod');
                    
                    // Define o ID da câmera no elemento
                    podElement.dataset.camId = camId;
                    
                    // Configura os elementos internos
                    podElement.querySelector('.cam-title').textContent = camId;
                    podElement.querySelector('.video-stream').src = '/video_feed/' + camId;
                    
                    // Adiciona o pod clonado na página
                    cameraColumn.appendChild(podElement);
                    
                    // Carrega o status individual desta câmera
                    loadInitialStatus(camId);
                }
            } catch (error) {
                console.error("Erro ao carregar câmeras:", error);
                document.getElementById('camera-column').innerHTML = "<h2>Erro ao carregar câmeras. Servidor está online?</h2>";
            }
        }
        
        /**
         * NOVO: Escutador de eventos centralizado para todos os botões das câmeras
         */
        function handleCameraControls(event) {
            const button = event.target;
            // Acha o "pod" da câmera pai deste botão
            const pod = button.closest('.camera-pod');
            if (!pod) return; // Sai se o clique não foi em um botão
            
            const camId = pod.dataset.camId;
            
            // Decide qual ação tomar baseado na classe do botão
            if (button.classList.contains('btn-start')) {
                sendCameraCommand(camId, 'start_recording');
            } else if (button.classList.contains('btn-stop')) {
                sendCameraCommand(camId, 'stop_recording');
            } else if (button.classList.contains('btn-motion')) {
                toggleMotionDetection(camId);
            }
        }

        /**
         * NOVO: Envia comandos de gravação (start/stop) para uma câmera específica
         */
        async function sendCameraCommand(camId, command) {
            const pod = document.querySelector(`.camera-pod[data-cam-id="${camId}"]`);
            const statusElement = pod.querySelector('.status-message');
            try {
                const response = await fetch(`/${command}/${camId}`, { method: 'POST' });
                const data = await response.json();
                statusElement.textContent = 'Status: ' + data.status;
            } catch (error) {
                console.error(`Erro no comando '${command}' para ${camId}:`, error);
                statusElement.textContent = 'Status: Erro de comunicação';
            }
        }

        /**
         * NOVO: Liga/desliga a detecção de movimento para uma câmera específica
         */
        async function toggleMotionDetection(camId) {
            const pod = document.querySelector(`.camera-pod[data-cam-id="${camId}"]`);
            const statusElement = pod.querySelector('.status-message');
            try {
                const response = await fetch(`/toggle_motion_detection/${camId}`, { method: 'POST' });
                const data = await response.json();
                statusElement.textContent = 'Status: ' + data.status;
                updateMotionButton(camId, data.enabled);
            } catch (error) {
                console.error(`Erro ao alternar detecção para ${camId}:`, error);
                statusElement.textContent = 'Status: Erro de comunicação';
            }
        }
        
        /**
         * NOVO: Carrega o status inicial de UMA câmera
         */
        async function loadInitialStatus(camId) {
            const pod = document.querySelector(`.camera-pod[data-cam-id="${camId}"]`);
            const statusElement = pod.querySelector('.status-message');
            try {
                const response = await fetch(`/get_status/${camId}`);
                const data = await response.json();
                statusElement.textContent = 'Status: ' + data.status;
                updateMotionButton(camId, data.motion_enabled);
            } catch (error) {
                statusElement.textContent = 'Status: Offline';
            }
        }
        
        /**
         * NOVO: Atualiza a aparência do botão de detecção de UMA câmera
         */
        function updateMotionButton(camId, isEnabled) {
            const pod = document.querySelector(`.camera-pod[data-cam-id="${camId}"]`);
            const motionButton = pod.querySelector('.btn-motion');
            if (isEnabled) {
                motionButton.textContent = 'Desligar Detecção';
                motionButton.classList.add('active');
            } else {
                motionButton.textContent = 'Ligar Detecção';
                motionButton.classList.remove('active');
            }
        }

        // --- Lógica do Player de Playback (Quase idêntica) ---
        
        const videoList = document.getElementById('video-list');
        const videoPlayer = document.getElementById('video-player');
        
        async function loadVideoList() {
            try {
                const response = await fetch('/list_videos');
                const data = await response.json();
                videoList.innerHTML = '';
                if (data.videos.length === 0) {
                    videoList.innerHTML = '<li>Nenhuma gravação encontrada.</li>';
                    return;
                }
                data.videos.forEach(filename => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.textContent = filename;
                    a.href = '#';
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        playVideo(filename);
                    });
                    li.appendChild(a);
                    videoList.appendChild(li);
                });
            } catch (error) {
                videoList.innerHTML = '<li>Erro ao carregar vídeos.</li>';
            }
        }
        
        function playVideo(filename) {
            const videoSource = videoPlayer.querySelector('source');
            const videoUrl = '/playback/' + filename;
            videoSource.setAttribute('src', videoUrl);
            videoPlayer.load();
            videoPlayer.play();
        }

    </script>
</body>
</html>